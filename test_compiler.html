<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroQuickJS Compiler Test</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .editor-section {
            margin-bottom: 30px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-icon {
            font-weight: bold;
            margin-right: 8px;
        }

        .bytecode-info {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .bytecode-info h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            font-family: 'Monaco', monospace;
        }

        .examples {
            margin-top: 20px;
        }

        .examples h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .example-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .hex-preview {
            margin-top: 15px;
            padding: 15px;
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 6px;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš€ MicroQuickJS Compiler</h1>
            <div class="subtitle">Compile JavaScript to bytecode in your browser</div>
        </header>

        <div class="main-content">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Loading compiler...</p>
            </div>

            <div id="editorSection" class="editor-section" style="display: none;">
                <div class="toolbar">
                    <button id="compileBtn" onclick="compileCode()">ðŸ”¨ Compile</button>
                    <button id="validateBtn" onclick="validateCode()" class="secondary">âœ“ Validate</button>
                    <button id="downloadBtn" onclick="downloadBytecode()" class="success" disabled>ðŸ’¾ Download .jsc</button>
                    <button onclick="clearEditor()" class="secondary">ðŸ—‘ Clear</button>
                </div>

                <div class="examples">
                    <h3>Load Example:</h3>
                    <div class="example-buttons">
                        <button onclick="loadExample('blink')" class="secondary">LED Blink</button>
                        <button onclick="loadExample('sensor')" class="secondary">Sensor Reading</button>
                        <button onclick="loadExample('button')" class="secondary">Button Handler</button>
                        <button onclick="loadExample('mqtt')" class="secondary">MQTT Publish</button>
                    </div>
                </div>

                <textarea id="codeEditor" placeholder="// Write your JavaScript code here...
// Example: LED blinker
function blink() {
    led.setColor(0, 255, 0, 0);
    setTimeout(function() {
        led.off(0);
        setTimeout(blink, 500);
    }, 500);
}

blink();"></textarea>

                <div id="status" class="status"></div>

                <div id="bytecodeInfo" class="bytecode-info">
                    <h3>ðŸ“Š Bytecode Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Size</div>
                            <div class="info-value"><span id="bytecodeSize">0</span> bytes</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Magic</div>
                            <div class="info-value" id="bytecodeMagic">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Version</div>
                            <div class="info-value" id="bytecodeVersion">-</div>
                        </div>
                    </div>
                    <div id="hexPreview" class="hex-preview"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="mquickjs.js"></script>
    <script src="mquickjs-compiler.js"></script>
    <script>
        // Global bytecode storage
        let compiledBytecode = null;

        // Example scripts
        const examples = {
            blink: `// LED Blinker
function blink() {
    led.setColor(0, 255, 0, 0);  // Red
    setTimeout(function() {
        led.off(0);
        setTimeout(blink, 500);
    }, 500);
}

blink();`,
            sensor: `// Read sensor values
var temp = sensor.getValue(0);
var humidity = sensor.getValue(1);

print("Temperature:", temp, "Â°C");
print("Humidity:", humidity, "%");`,
            button: `// Button click handler
button.onClick(0, function() {
    print("Button 0 clicked!");
    led.setColor(0, 0, 255, 0);  // Green
});

button.onLongPress(0, function() {
    print("Button 0 long pressed!");
    led.setColor(0, 255, 0, 0);  // Red
});`,
            mqtt: `// Publish to MQTT
var temp = sensor.getValue(0);
var humidity = sensor.getValue(1);

mqtt.publish("home/sensors/temperature", temp.toString());
mqtt.publish("home/sensors/humidity", humidity.toString());

print("Published sensor data to MQTT");`
        };

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';
            statusDiv.innerHTML = `<span class="status-icon">${icon}</span>${message}`;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';

            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Format bytes as hex dump
        function formatHexDump(bytes, limit = 256) {
            const displayBytes = bytes.slice(0, limit);
            let output = '';

            for (let i = 0; i < displayBytes.length; i += 16) {
                // Offset
                output += i.toString(16).padStart(8, '0') + ':  ';

                // Hex values
                for (let j = 0; j < 16; j++) {
                    if (i + j < displayBytes.length) {
                        output += displayBytes[i + j].toString(16).padStart(2, '0') + ' ';
                    } else {
                        output += '   ';
                    }
                    if (j === 7) output += ' ';
                }

                output += ' |';

                // ASCII representation
                for (let j = 0; j < 16 && i + j < displayBytes.length; j++) {
                    const byte = displayBytes[i + j];
                    output += (byte >= 32 && byte < 127) ? String.fromCharCode(byte) : '.';
                }

                output += '|\n';
            }

            if (bytes.length > limit) {
                output += `\n... (${bytes.length - limit} more bytes)`;
            }

            return output;
        }

        // Compile JavaScript code
        async function compileCode() {
            const sourceCode = document.getElementById('codeEditor').value;

            if (!sourceCode.trim()) {
                showStatus('Please enter some JavaScript code', 'error');
                return;
            }

            showStatus('Compiling...', 'info');
            document.getElementById('compileBtn').disabled = true;

            try {
                compiledBytecode = await mqjsCompiler.compile(sourceCode, {
                    targetAddr: 0,
                    use32Bit: true
                });

                showStatus(`âœ“ Compilation successful! (${compiledBytecode.length} bytes)`, 'success');

                // Show bytecode info
                displayBytecodeInfo(compiledBytecode);
                document.getElementById('downloadBtn').disabled = false;

            } catch (err) {
                showStatus('Compilation failed: ' + err.message, 'error');
                compiledBytecode = null;
                document.getElementById('bytecodeInfo').style.display = 'none';
                document.getElementById('downloadBtn').disabled = true;
            } finally {
                document.getElementById('compileBtn').disabled = false;
            }
        }

        // Validate code syntax
        async function validateCode() {
            const sourceCode = document.getElementById('codeEditor').value;

            if (!sourceCode.trim()) {
                showStatus('Please enter some JavaScript code', 'error');
                return;
            }

            showStatus('Validating...', 'info');
            document.getElementById('validateBtn').disabled = true;

            try {
                await mqjsCompiler.validate(sourceCode);
                showStatus('âœ“ Code is valid!', 'success');
            } catch (err) {
                showStatus('Validation failed: ' + err.message, 'error');
            } finally {
                document.getElementById('validateBtn').disabled = false;
            }
        }

        // Display bytecode information
        function displayBytecodeInfo(bytecode) {
            const view = new DataView(bytecode.buffer);

            // Read header (assuming little-endian)
            const magic = view.getUint16(0, true);
            const version = view.getUint16(2, true);

            document.getElementById('bytecodeSize').textContent = bytecode.length;
            document.getElementById('bytecodeMagic').textContent = '0x' + magic.toString(16).padStart(4, '0');
            document.getElementById('bytecodeVersion').textContent = version;

            // Show hex dump
            document.getElementById('hexPreview').textContent = formatHexDump(bytecode);

            document.getElementById('bytecodeInfo').style.display = 'block';
        }

        // Download compiled bytecode
        function downloadBytecode() {
            if (!compiledBytecode) {
                showStatus('Please compile first', 'error');
                return;
            }

            const blob = new Blob([compiledBytecode], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'script.jsc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('Downloaded script.jsc', 'success');
        }

        // Load example script
        function loadExample(name) {
            if (examples[name]) {
                document.getElementById('codeEditor').value = examples[name];
                showStatus('Loaded ' + name + ' example', 'success');
            }
        }

        // Clear editor
        function clearEditor() {
            document.getElementById('codeEditor').value = '';
            document.getElementById('bytecodeInfo').style.display = 'none';
            compiledBytecode = null;
            document.getElementById('downloadBtn').disabled = true;
        }

        // Initialize
        (async function() {
            try {
                await mqjsCompiler.init();

                // Hide loading, show editor
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('editorSection').style.display = 'block';

                // Load default example
                loadExample('blink');

                showStatus('âœ“ Compiler ready! Try compiling the example code.', 'success');
            } catch (err) {
                document.getElementById('loadingIndicator').innerHTML =
                    '<h2 style="color: #721c24;">Failed to load compiler</h2>' +
                    '<p>' + err.message + '</p>' +
                    '<p>Make sure you\'re running this from a web server (not file://)</p>';
            }
        })();
    </script>
</body>
</html>
